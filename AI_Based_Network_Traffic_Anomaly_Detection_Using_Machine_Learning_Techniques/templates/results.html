{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="bg-white rounded-3 shadow-sm p-4">
                <h2 class="display-6 text-primary mb-3">
                    <i class="fas fa-table me-3"></i>Prediction Results
                </h2>
                <p class="lead text-muted">
                    View and analyze the prediction results from your machine learning models.
                </p>
            </div>
        </div>
    </div>

    {% if columns and rows %}
    <!-- Results Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-white bg-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Total Records</h6>
                            <h3 class="mb-0">{{ rows|length }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-database fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-white bg-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Normal Traffic</h6>
                            <h3 class="mb-0" id="normal-count">{{ normal_count if normal_count is defined else 0 }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-shield-alt fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-white bg-danger">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Attack Traffic</h6>
                            <h3 class="mb-0" id="attack-count">{{ attack_count if attack_count is defined else 0 }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-white bg-warning">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Risk Level</h6>
                            <h3 class="mb-0" id="risk-level">{{ risk_level if risk_level is defined else 'Low' }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-exclamation fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Data Table -->
        <div class="col-lg-8">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>Detailed Results
                    </h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-light btn-sm" onclick="exportToCSV()" title="Export to CSV">
                            <i class="fas fa-download me-1"></i>CSV
                        </button>
                        <button class="btn btn-light btn-sm" onclick="exportToJSON()" title="Export to JSON">
                            <i class="fas fa-code me-1"></i>JSON
                        </button>
                        <button class="btn btn-light btn-sm" onclick="printResults()" title="Print Results">
                            <i class="fas fa-print me-1"></i>Print
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table id="predictionTable" class="table table-hover table-striped mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>#</th>
                                    {% for col in columns %}
                                        <th>{{ col }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in rows %}
                                    <tr>
                                        <td class="fw-bold">{{ loop.index }}</td>
                                        {% for item in row %}
                                            {% if loop.last and 'prediction' in columns[-1].lower() %}
                                                <td>
                                                    {% if item == 1 or item == 'attack' or item == 'Attack' %}
                                                        <span class="badge bg-danger">
                                                            <i class="fas fa-exclamation-triangle me-1"></i>Attack
                                                        </span>
                                                    {% else %}
                                                        <span class="badge bg-success">
                                                            <i class="fas fa-shield-alt me-1"></i>Normal
                                                        </span>
                                                    {% endif %}
                                                </td>
                                            {% else %}
                                                <td>{{ item }}</td>
                                            {% endif %}
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Showing {{ rows|length }} results
                        </small>
                        <div class="pagination-info">
                            <small class="text-muted">Use table controls above to navigate</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis Panel -->
        <div class="col-lg-4">
            <!-- Prediction Distribution Chart -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-info text-white">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Prediction Distribution
                    </h6>
                </div>
                <div class="card-body">
                    <canvas id="distributionChart" width="300" height="300"></canvas>
                </div>
            </div>

            <!-- Quick Statistics -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-success text-white">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-calculator me-2"></i>Quick Statistics
                    </h6>
                </div>
                <div class="card-body">
                    <div class="stats-grid">
                        <div class="stat-item mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Total Predictions:</span>
                                <strong>{{ rows|length }}</strong>
                            </div>
                        </div>
                        
                        <div class="stat-item mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Normal Traffic:</span>
                                <strong class="text-success" id="normal-percentage">
                                    {% if rows|length > 0 %}
                                        {{ "%.1f"|format((normal_count / rows|length * 100) if normal_count is defined else 0) }}%
                                    {% else %}
                                        0%
                                    {% endif %}
                                </strong>
                            </div>
                        </div>
                        
                        <div class="stat-item mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Attack Traffic:</span>
                                <strong class="text-danger" id="attack-percentage">
                                    {% if rows|length > 0 %}
                                        {{ "%.1f"|format((attack_count / rows|length * 100) if attack_count is defined else 0) }}%
                                    {% else %}
                                        0%
                                    {% endif %}
                                </strong>
                            </div>
                        </div>
                        
                        <div class="stat-item mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Features Count:</span>
                                <strong>{{ columns|length - 1 if 'prediction' in columns else columns|length }}</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filter Controls -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-warning text-dark">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-filter me-2"></i>Filter Results
                    </h6>
                </div>
                <div class="card-body">
                    <div class="filter-controls">
                        <div class="mb-3">
                            <label class="form-label">Show Predictions:</label>
                            <select class="form-select form-select-sm" id="predictionFilter">
                                <option value="all">All Predictions</option>
                                <option value="normal">Normal Only</option>
                                <option value="attack">Attack Only</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Records per page:</label>
                            <select class="form-select form-select-sm" id="recordsPerPage">
                                <option value="10">10</option>
                                <option value="25" selected>25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="-1">All</option>
                            </select>
                        </div>
                        
                        <button class="btn btn-outline-primary btn-sm w-100" onclick="applyFilters()">
                            <i class="fas fa-search me-1"></i>Apply Filters
                        </button>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-secondary text-white">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="/predict-page" class="btn btn-primary btn-sm">
                            <i class="fas fa-plus me-2"></i>New Prediction
                        </a>
                        <button class="btn btn-success btn-sm" onclick="downloadFullReport()">
                            <i class="fas fa-file-download me-2"></i>Download Report
                        </button>
                        <a href="/performance" class="btn btn-info btn-sm">
                            <i class="fas fa-chart-line me-2"></i>View Performance
                        </a>
                        <button class="btn btn-warning btn-sm" onclick="refreshResults()">
                            <i class="fas fa-sync me-2"></i>Refresh Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {% else %}
    <!-- No Results State -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center py-5">
                    <i class="fas fa-inbox fa-4x text-muted mb-4"></i>
                    <h4 class="text-muted mb-3">No Prediction Results Available</h4>
                    <p class="text-muted mb-4">
                        You haven't made any predictions yet. Upload your data and generate predictions to see results here.
                    </p>
                    <div class="d-flex justify-content-center gap-3">
                        <a href="/predict-page" class="btn btn-primary">
                            <i class="fas fa-brain me-2"></i>Make Predictions
                        </a>
                        <a href="/" class="btn btn-outline-primary">
                            <i class="fas fa-cogs me-2"></i>Train Model
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{% if columns and rows %}
<script>
$(document).ready(function() {
    // Initialize DataTable if jQuery and DataTable are available
    if (typeof $ !== 'undefined' && $.fn.DataTable) {
        try {
            var table = $('#predictionTable').DataTable({
                responsive: true,
                pageLength: 25,
                order: [[0, 'asc']],
                columnDefs: [
                    { orderable: false, targets: 0 },
                    { className: "text-center", targets: 0 }
                ]
            });
        } catch (e) {
            console.log("DataTable initialization failed:", e);
        }
    }

    // Calculate and display statistics
    calculateStats();
    
    // Create distribution chart if Chart.js is available
    if (typeof Chart !== 'undefined') {
        createDistributionChart();
    }
});

function calculateStats() {
    var totalRows = {{ rows|length }};
    var normalCount = {{ normal_count if normal_count is defined else 0 }};
    var attackCount = {{ attack_count if attack_count is defined else 0 }};
    
    // Update percentage displays
    if (totalRows > 0) {
        var normalPercentage = ((normalCount / totalRows) * 100).toFixed(1);
        var attackPercentage = ((attackCount / totalRows) * 100).toFixed(1);
        
        $('#normal-percentage').text(normalPercentage + '%');
        $('#attack-percentage').text(attackPercentage + '%');
    }
}

function createDistributionChart() {
    var ctx = document.getElementById('distributionChart');
    if (!ctx) return;
    
    var normalCount = {{ normal_count if normal_count is defined else 0 }};
    var attackCount = {{ attack_count if attack_count is defined else 0 }};
    
    try {
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Normal Traffic', 'Attack Traffic'],
                datasets: [{
                    data: [normalCount, attackCount],
                    backgroundColor: ['#28a745', '#dc3545'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    } catch (e) {
        console.log("Chart creation failed:", e);
        // Fallback: show simple text statistics
        ctx.getContext('2d').fillText('Normal: ' + normalCount + ', Attack: ' + attackCount, 10, 50);
    }
}

// Export functions
function exportToCSV() {
    window.location.href = '/download/results';
}

function exportToJSON() {
    // Convert table data to JSON and download
    var data = {
        columns: {{ columns|tojson if columns else '[]' }},
        rows: {{ rows|tojson if rows else '[]' }},
        statistics: {
            total: {{ rows|length }},
            normal: {{ normal_count if normal_count is defined else 0 }},
            attack: {{ attack_count if attack_count is defined else 0 }}
        }
    };
    
    var blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'prediction_results.json';
    a.click();
    URL.revokeObjectURL(url);
}

function printResults() {
    window.print();
}

function applyFilters() {
    var filterValue = $('#predictionFilter').val();
    var recordsPerPage = $('#recordsPerPage').val();
    
    if (typeof table !== 'undefined') {
        // Apply DataTable filters
        if (recordsPerPage !== '-1') {
            table.page.len(parseInt(recordsPerPage)).draw();
        }
        
        // Apply prediction filter
        if (filterValue !== 'all') {
            table.column(-1).search(filterValue === 'normal' ? 'Normal' : 'Attack').draw();
        } else {
            table.column(-1).search('').draw();
        }
    }
}

function downloadFullReport() {
    window.location.href = '/download/results';
}

function refreshResults() {
    location.reload();
}
</script>
{% endif %}
{% endblock %}